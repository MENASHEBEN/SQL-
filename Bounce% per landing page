USE mavenfuzzyfactory;
CREATE temporary table t1
SELECT website_sessions.website_session_id,website_pageviews.pageview_url,
website_pageviews.created_at, COUNT(website_pageviews.website_pageview_id) AS n_pageviews,
MIN(website_pageviews.website_pageview_id) AS f_pageview_id
FROM website_sessions
LEFT JOIN website_pageviews
ON website_sessions.website_session_id=website_pageviews.website_session_id
WHERE website_sessions.utm_campaign='nonbrand' AND website_sessions.utm_source='gsearch'
AND website_sessions.created_at BETWEEN '2012-06-01' AND '2012-08-31'
GROUP BY 1;

SELECT MIN(DATE(created_at)) AS start_week,
COUNT(DISTINCT website_session_id) AS sessions,
COUNT(DISTINCT CASE WHEN n_pageviews='1' then website_session_id ELSE NULL END) AS bounces,
COUNT(DISTINCT CASE WHEN n_pageviews='1' then website_session_id ELSE NULL END)/COUNT(DISTINCT website_session_id) AS b_perc,
COUNT(DISTINCT CASE WHEN pageview_url='/home' then website_session_id ELSE NULL END) AS home,
COUNT(DISTINCT CASE WHEN pageview_url='/lander-1' then website_session_id ELSE NULL END) AS lander
from t1
GROUP BY WEEK(created_at);

